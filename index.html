<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promo Payoff Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #F9FAFB;
            --bg-card: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563; 
            --border: #E5E7EB;
            --input-bg: #F3F4F6;
        }

        html.dark {
            --bg: #111827;
            --bg-card: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --border: #374151;
            --input-bg: #374151;
        }

        body {
            background-color: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            @apply rounded-2xl shadow-sm;
        }

        .form-input {
            background-color: var(--input-bg);
            border-color: var(--border);
            color: var(--text-primary);
            @apply w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200;
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .calculate-card {
            @apply p-0 cursor-pointer hover:border-indigo-400/50 transition-colors duration-300;
        }
    </style>
</head>
<body class="min-h-screen font-sans">
    
    <div class="container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                 <i data-lucide="piggy-bank" class="w-10 h-10 text-indigo-500"></i>
                <h1 class="text-3xl font-bold">
                    <span class="bg-gradient-to-r from-indigo-500 to-purple-500 bg-clip-text text-transparent">
                        Promo Payoff Calculator
                    </span>
                </h1>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                <i data-lucide="sun" id="sun-icon" class="hidden"></i>
                <i data-lucide="moon" id="moon-icon" class="hidden"></i>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-2 flex flex-col gap-6">
                
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Configuration</h2>
                    <div class="space-y-2">
                        <div class="grid grid-cols-3 gap-4">
                            <label for="startDate" class="block text-sm font-medium" style="color: var(--text-secondary);">Start Date</label>
                            <label for="paymentDay" class="block text-sm font-medium" style="color: var(--text-secondary);">Payment Day</label>
                            <label for="minPaymentRate" class="block text-sm font-medium" style="color: var(--text-secondary);">Min. %</label>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <input type="date" id="startDate" class="form-input">
                            <input type="number" id="paymentDay" class="form-input" value="15" min="1" max="28">
                            <input type="number" id="minPaymentRate" class="form-input" value="4" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Standard Balances</h2>
                    <div id="standard-balances-container" class="space-y-3"></div>
                    <button id="add-standard-btn" class="w-full mt-4 flex items-center justify-center gap-2 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Balance
                    </button>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Promotional Balances</h2>
                    <div id="promo-balances-container" class="space-y-3"></div>
                    <button id="add-promo-btn" class="w-full mt-4 flex items-center justify-center gap-2 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Promo
                    </button>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Existing Savings</h2>
                    <label for="existingSavings" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Amount currently saved</label>
                    <input type="text" id="existingSavings" class="form-input" placeholder="0.00">
                </div>

                <button id="calculate-btn" class="card calculate-card p-4">
                    <span class="text-3xl font-bold bg-gradient-to-r from-indigo-500 to-purple-500 bg-clip-text text-transparent">
                        Calculate Plan
                    </span>
                </button>
            </div>

            <div id="results-section" class="lg:col-span-3 hidden">
                 <div class="card p-6 sticky top-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold ">Your Payoff Plan</h2>
                            <p id="plan-duration" style="color: var(--text-secondary);"></p>
                        </div>
                        <button id="download-csv-btn" class="py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                            <i data-lucide="download"></i> Download CSV
                        </button>
                    </div>

                    <div class="bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-800 rounded-lg p-6 text-center mb-6 flex justify-around">
                        <div>
                            <p class="text-sm text-indigo-400">Current Target Payment</p>
                            <p id="flat-payment-result" class="text-4xl font-bold text-indigo-700 dark:text-indigo-400"></p>
                        </div>
                    </div>

                    <div class="overflow-auto max-h-[60vh] rounded-lg border" style="border-color: var(--border);">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="sticky top-0 z-10" style="background-color: var(--input-bg);">
                                <tr>
                                    <th class="p-3">Month</th>
                                    <th class="p-3 text-right">Target Payment</th>
                                    <th class="p-3 text-right">Min Pmt</th>
                                    <th class="p-3 text-right">Interest</th>
                                    <th class="p-3 text-right">Std Principal</th>
                                    <th class="p-3 text-right">Saved</th>
                                    <th class="p-3 text-right">Total Saved</th>
                                    <th class="p-3 text-right">Std Bal</th>
                                    <th class="p-3 text-right">Promo Bal</th>
                                    <th class="p-3 text-center">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const themeToggleBtn = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const applyTheme = (theme) => {
                document.documentElement.className = theme;
                sunIcon.style.display = theme === 'dark' ? 'block' : 'none';
                moonIcon.style.display = theme === 'light' ? 'block' : 'none';
            };
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            const docElements = {
                startDate: document.getElementById('startDate'),
                paymentDay: document.getElementById('paymentDay'),
                minPaymentRate: document.getElementById('minPaymentRate'),
                standardContainer: document.getElementById('standard-balances-container'),
                promoContainer: document.getElementById('promo-balances-container'),
                addStandardBtn: document.getElementById('add-standard-btn'),
                addPromoBtn: document.getElementById('add-promo-btn'),
                existingSavings: document.getElementById('existingSavings'),
                calculateBtn: document.getElementById('calculate-btn'),
                resultsSection: document.getElementById('results-section'),
                planDuration: document.getElementById('plan-duration'),
                flatPaymentResult: document.getElementById('flat-payment-result'),
                resultsTableBody: document.getElementById('results-table-body'),
                downloadCsvBtn: document.getElementById('download-csv-btn')
            };
            let calculationResultData = [];

            const formatNumberInput = (e) => {
                let input = e.target;
                let value = input.value.replace(/[^0-9.]/g, '');
                let parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                if (parts.length > 1) {
                    parts[1] = parts[1].substring(0, 2);
                }
                input.value = parts.join('.');
            };

            const createRow = (container, type) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 dynamic-row';
                row.innerHTML = `
                    <div class="grid grid-cols-5 gap-2 flex-1">
                        <input type="text" class="form-input col-span-3" placeholder="Balance ($)" data-field="balance" inputmode="decimal">
                        <input type="${type === 'standard' ? 'number' : 'date'}" step="0.01" class="form-input col-span-2" placeholder="${type === 'standard' ? 'APR (%)' : ''}" data-field="detail">
                    </div>
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 remove-row-btn">
                        <i data-lucide="minus-circle" class="w-5 h-5 text-gray-500"></i>
                    </button>
                `;
                container.appendChild(row);
                row.querySelector('[data-field="balance"]').addEventListener('input', formatNumberInput);
                lucide.createIcons();
                updateRemoveButtons();
            };

            const updateRemoveButtons = () => {
                [docElements.standardContainer, docElements.promoContainer].forEach(container => {
                    const rows = container.querySelectorAll('.dynamic-row');
                    rows.forEach((row, index) => {
                        row.querySelector('.remove-row-btn').style.display = rows.length > 1 ? 'flex' : 'none';
                    });
                });
            };

            const saveData = () => {
                const getRowData = (c) => Array.from(c.querySelectorAll('.dynamic-row')).map(r => ({ balance: r.querySelector('[data-field="balance"]').value, detail: r.querySelector('[data-field="detail"]').value }));
                const data = {
                    startDate: docElements.startDate.value, paymentDay: docElements.paymentDay.value,
                    minPaymentRate: docElements.minPaymentRate.value, existingSavings: docElements.existingSavings.value,
                    standardBalances: getRowData(docElements.standardContainer),
                    promoBalances: getRowData(docElements.promoContainer)
                };
                localStorage.setItem('calculatorData', JSON.stringify(data));
            };

            const loadData = () => {
                const data = JSON.parse(localStorage.getItem('calculatorData'));
                if (!data) {
                    docElements.startDate.valueAsDate = new Date();
                    createRow(docElements.standardContainer, 'standard');
                    createRow(docElements.promoContainer, 'promo');
                    return;
                }
                docElements.startDate.value = data.startDate || new Date().toISOString().split('T')[0];
                docElements.paymentDay.value = data.paymentDay || 15;
                docElements.minPaymentRate.value = data.minPaymentRate || 4;
                docElements.existingSavings.value = data.existingSavings || '';

                const loadRows = (container, type, items) => {
                    container.innerHTML = '';
                    (items && items.length > 0 ? items : [{balance: '', detail: ''}]).forEach(item => {
                        createRow(container, type);
                        const lastRow = container.lastElementChild;
                        lastRow.querySelector('[data-field="balance"]').value = item.balance;
                        lastRow.querySelector('[data-field="detail"]').value = item.detail;
                    });
                };
                loadRows(docElements.standardContainer, 'standard', data.standardBalances);
                loadRows(docElements.promoContainer, 'promo', data.promoBalances);
                updateRemoveButtons();
            };
            
            const getNumericValue = (str) => parseFloat(String(str).replace(/,/g, '')) || 0;

            const calculatePlan = () => {
                let standardBalances = Array.from(docElements.standardContainer.querySelectorAll('.dynamic-row'))
                    .map(r => ({ balance: getNumericValue(r.querySelector('[data-field="balance"]').value), apr: getNumericValue(r.querySelector('[data-field="detail"]').value) / 100 }))
                    .filter(b => b.balance > 0);
                
                let promoBalances = Array.from(docElements.promoContainer.querySelectorAll('.dynamic-row'))
                    .map(r => ({ balance: getNumericValue(r.querySelector('[data-field="balance"]').value), expires: r.querySelector('[data-field="detail"]').value }))
                    .filter(p => p.balance > 0 && p.expires);
                
                promoBalances.sort((a, b) => new Date(a.expires) - new Date(b.expires));

                let existingSavings = getNumericValue(docElements.existingSavings.value);
                const paymentDay = parseInt(docElements.paymentDay.value);
                const minPaymentRate = getNumericValue(docElements.minPaymentRate.value) / 100 || 0.04;
                
                const startDate = new Date(docElements.startDate.value + "T12:00:00Z");
                let currentDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), paymentDay));
                if (startDate.getUTCDate() >= paymentDay) currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);

                let currentStandardBalance = standardBalances.reduce((sum, b) => sum + b.balance, 0);
                let weightedAPR = currentStandardBalance > 0 ? standardBalances.reduce((sum, b) => sum + b.balance * b.apr, 0) / currentStandardBalance : 0;
                let monthlyAPR = weightedAPR / 12;

                calculationResultData = [];
                let cumulativeSavings = existingSavings;
                let balTracker = currentStandardBalance;
                let activePromos = JSON.parse(JSON.stringify(promoBalances));

                const getRequiredPayment = (sim_std_start, sim_promos_start, sim_sav_start, sim_date_start) => {
                    if (sim_promos_start.length === 0 && sim_std_start <= 0.01) return 0;
                    
                    let low = 0, high = 100000, best_P = 100000;
                    for (let iter = 0; iter < 60; iter++) {
                        let mid = (low + high) / 2;
                        let sim_std = sim_std_start;
                        let sim_promos = JSON.parse(JSON.stringify(sim_promos_start));
                        let sim_sav = sim_sav_start;
                        let sim_date = new Date(sim_date_start.getTime());
                        let valid = true;

                        while (sim_promos.length > 0) {
                            let interest = sim_std > 0 ? sim_std * monthlyAPR : 0;
                            let total_promo = sim_promos.reduce((s, p) => s + p.balance, 0);
                            let total_bal = sim_std + total_promo;
                            
                            if (total_bal <= 0.01) break;

                            let min_pmt = total_bal * minPaymentRate;
                            if (total_bal < 35) min_pmt = total_bal;
                            else if (min_pmt < 35) min_pmt = 35;

                            let actual_pmt = Math.max(mid, min_pmt);
                            let principal = min_pmt - interest;
                            if (principal > total_bal) principal = total_bal;

                            if (principal <= sim_std) {
                                sim_std -= principal;
                            } else {
                                let excess = principal - sim_std;
                                sim_std = 0;
                                for (let i = 0; i < sim_promos.length; i++) {
                                    if (excess <= 0) break;
                                    if (sim_promos[i].balance >= excess) {
                                        sim_promos[i].balance -= excess;
                                        excess = 0;
                                    } else {
                                        excess -= sim_promos[i].balance;
                                        sim_promos[i].balance = 0;
                                    }
                                }
                            }
                            sim_sav += (actual_pmt - min_pmt);

                            for (let i = 0; i < sim_promos.length; i++) {
                                let exp_date = new Date(sim_promos[i].expires + "T12:00:00Z");
                                let target_date = new Date(Date.UTC(exp_date.getUTCFullYear(), exp_date.getUTCMonth(), paymentDay));
                                if (target_date > exp_date) target_date.setUTCMonth(target_date.getUTCMonth() - 1);
                                target_date.setUTCMonth(target_date.getUTCMonth() - 1);
                                
                                if (sim_date.getUTCFullYear() > target_date.getUTCFullYear() || 
                                   (sim_date.getUTCFullYear() === target_date.getUTCFullYear() && sim_date.getUTCMonth() >= target_date.getUTCMonth())) {
                                    if (sim_sav < sim_promos[i].balance - 0.01) {
                                        valid = false;
                                        break;
                                    }
                                    sim_sav -= sim_promos[i].balance;
                                    sim_promos[i].balance = 0;
                                }
                            }
                            
                            if (!valid) break;
                            sim_promos = sim_promos.filter(p => p.balance > 0.01);
                            sim_date.setUTCMonth(sim_date.getUTCMonth() + 1);
                        }

                        if (valid) {
                            best_P = mid;
                            high = mid;
                        } else {
                            low = mid;
                        }
                    }
                    return best_P;
                };

                let current_P = getRequiredPayment(balTracker, activePromos, cumulativeSavings, currentDate);
                let was_std_bal_zero = (balTracker <= 0.01);
                let last_promo_count = activePromos.length;
                let sanityCounter = 0;

                while ((balTracker > 0.01 || activePromos.length > 0) && sanityCounter < 360) {
                    sanityCounter++;
                    
                    let interest = balTracker > 0 ? balTracker * monthlyAPR : 0;
                    let total_promo = activePromos.reduce((s, p) => s + p.balance, 0);
                    let total_bal = balTracker + total_promo;
                    
                    let min_pmt = total_bal * minPaymentRate;
                    if (total_bal < 35) min_pmt = total_bal;
                    else if (min_pmt < 35) min_pmt = 35;

                    let actual_pmt = Math.max(current_P, min_pmt);
                    
                    let principal = min_pmt - interest;
                    if (principal > total_bal) principal = total_bal;

                    let excess_min = 0;
                    if (principal <= balTracker) {
                        balTracker -= principal;
                    } else {
                        excess_min = principal - balTracker;
                        balTracker = 0;
                        for (let i = 0; i < activePromos.length; i++) {
                            if (excess_min <= 0) break;
                            if (activePromos[i].balance >= excess_min) {
                                activePromos[i].balance -= excess_min;
                                excess_min = 0;
                            } else {
                                excess_min -= activePromos[i].balance;
                                activePromos[i].balance = 0;
                            }
                        }
                    }

                    let savings_contrib = actual_pmt - min_pmt;
                    cumulativeSavings += savings_contrib;

                    let actionNote = "";

                    for (let i = 0; i < activePromos.length; i++) {
                        let exp_date = new Date(activePromos[i].expires + "T12:00:00Z");
                        let target_date = new Date(Date.UTC(exp_date.getUTCFullYear(), exp_date.getUTCMonth(), paymentDay));
                        if (target_date > exp_date) target_date.setUTCMonth(target_date.getUTCMonth() - 1);
                        target_date.setUTCMonth(target_date.getUTCMonth() - 1);
                        
                        if (currentDate.getUTCFullYear() > target_date.getUTCFullYear() || 
                           (currentDate.getUTCFullYear() === target_date.getUTCFullYear() && currentDate.getUTCMonth() >= target_date.getUTCMonth())) {
                            
                            let amountToPay = activePromos[i].balance;
                            if (amountToPay > 0.01) {
                                if (cumulativeSavings >= amountToPay - 0.05) {
                                    cumulativeSavings -= amountToPay;
                                    activePromos[i].balance = 0;
                                    if (actionNote !== "") actionNote += " & ";
                                    actionNote += `Paid Off Promo ($${amountToPay.toFixed(2)})`;
                                } else {
                                    actionNote += `[ERROR] Short $${(amountToPay - cumulativeSavings).toFixed(2)}`;
                                }
                            }
                        }
                    }

                    let ending_promo_bal = activePromos.reduce((s, p) => s + p.balance, 0);
                    cumulativeSavings = Math.max(0, cumulativeSavings);

                    calculationResultData.push({
                        Month: currentDate.toLocaleDateString('en-CA'),
                        Target_Payment: actual_pmt.toFixed(2),
                        Minimum_Payment: min_pmt.toFixed(2),
                        Interest_Paid: interest.toFixed(2),
                        Standard_Principal: (principal - excess_min).toFixed(2),
                        Savings_Contribution: savings_contrib.toFixed(2),
                        Cumulative_Savings: cumulativeSavings.toFixed(2),
                        Ending_Standard_Balance: balTracker.toFixed(2),
                        Ending_Promo_Balance: ending_promo_bal.toFixed(2),
                        Notes: actionNote
                    });

                    activePromos = activePromos.filter(p => p.balance > 0.01);
                    currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);

                    let need_recalc = false;
                    let is_std_bal_zero = (balTracker <= 0.01);
                    
                    if (is_std_bal_zero && !was_std_bal_zero) need_recalc = true;
                    if (activePromos.length < last_promo_count) need_recalc = true;
                    
                    if (need_recalc && (balTracker > 0.01 || activePromos.length > 0)) {
                        current_P = getRequiredPayment(balTracker, activePromos, cumulativeSavings, currentDate);
                    }
                    
                    was_std_bal_zero = is_std_bal_zero;
                    last_promo_count = activePromos.length;
                }

                let initialFlatPayment = 0;
                if (calculationResultData.length > 0) {
                    initialFlatPayment = Math.max(parseFloat(calculationResultData[0].Target_Payment), parseFloat(calculationResultData[0].Minimum_Payment));
                }

                displayResults(initialFlatPayment, calculationResultData.length);
            };

            const displayResults = (flatPayment, duration) => {
                docElements.planDuration.textContent = `${duration}-Month Payoff Plan`;
                docElements.flatPaymentResult.textContent = `$${(new Intl.NumberFormat().format(flatPayment.toFixed(2)))}`;
                docElements.resultsTableBody.innerHTML = calculationResultData.map(row => `
                    <tr class="border-b" style="border-color: var(--border);">
                        <td class="p-3">${row.Month}</td>
                        <td class="p-3 text-right font-medium">$${row.Target_Payment}</td>
                        <td class="p-3 text-right text-gray-500">$${row.Minimum_Payment}</td>
                        <td class="p-3 text-right text-red-500">$${row.Interest_Paid}</td>
                        <td class="p-3 text-right text-green-600">$${row.Standard_Principal}</td>
                        <td class="p-3 text-right">$${row.Savings_Contribution}</td>
                        <td class="p-3 text-right font-semibold">$${row.Cumulative_Savings}</td>
                        <td class="p-3 text-right">$${row.Ending_Standard_Balance}</td>
                        <td class="p-3 text-right text-indigo-500">$${row.Ending_Promo_Balance}</td>
                        <td class="p-3 text-center text-xs font-bold text-purple-600">${row.Notes}</td>
                    </tr>
                `).join('');
                docElements.resultsSection.classList.remove('hidden');
            };
            
            const downloadCSV = () => {
                if(calculationResultData.length === 0) return;
                const headers = Object.keys(calculationResultData[0]);
                const csv = [headers.join(','), ...calculationResultData.map(r => headers.map(h => `"${r[h]}"`).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'payoff_schedule.csv';
                link.click();
                URL.revokeObjectURL(link.href);
            };
            
            docElements.addStandardBtn.addEventListener('click', () => createRow(docElements.standardContainer, 'standard'));
            docElements.addPromoBtn.addEventListener('click', () => createRow(docElements.promoContainer, 'promo'));
            docElements.existingSavings.addEventListener('input', formatNumberInput);
            document.querySelector('main').addEventListener('click', e => {
                if (e.target.closest('.remove-row-btn')) {
                    e.target.closest('.dynamic-row').remove();
                    updateRemoveButtons();
                    saveData();
                }
            });
            document.querySelector('main').addEventListener('input', saveData);
            docElements.calculateBtn.addEventListener('click', calculatePlan);
            docElements.downloadCsvBtn.addEventListener('click', downloadCSV);

            loadData();
        });
    </script>
</body>
</html>
